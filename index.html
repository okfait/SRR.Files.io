<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRR FILES v3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        
        :root {
            --glass-base: rgba(20, 20, 25, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: rgba(255, 255, 255, 0.95);
            --text-dim: rgba(255, 255, 255, 0.5);
            --accent: #60a5fa; /* Default Blue */
            --accent-glow: rgba(96, 165, 250, 0.3);
            --critical: #ef4444;
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        /* THEME OVERRIDES */
        body.theme-red { 
            --accent: #ef4444; 
            --accent-glow: rgba(239, 68, 68, 0.3); 
        }

        /* CUSTOM SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        /* ANIMATED BACKGROUND */
        #bg-layer { position: fixed; inset: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, #050508 0%, #000000 60%); opacity: 1; z-index: -3; animation: spin-slow 120s linear infinite; pointer-events: none; }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }

        /* GLASS PANELS */
        .glass-panel { 
            background: var(--glass-base); 
            backdrop-filter: blur(20px) saturate(110%); 
            -webkit-backdrop-filter: blur(20px) saturate(110%);
            border: 1px solid var(--glass-border); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            border-radius: var(--radius-lg); 
        }

        /* TOP BAR */
        .top-bar { 
            position: sticky; top: 0; z-index: 50; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px 30px; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--glass-border);
        }

        /* DATA TABLE STYLING */
        .case-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 120px 1.5fr 2fr; 
            align-items: center;
            gap: 15px;
            padding: 16px 20px; 
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            background: rgba(255,255,255,0.02);
            border: 1px solid transparent;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .case-row:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        .case-row.critical {
            border-left-color: var(--critical);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, rgba(255,255,255,0.02) 100%);
        }

        .case-row.header {
            background: transparent;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
            color: var(--text-dim);
            padding: 10px 20px;
            pointer-events: none;
            border: none;
        }

        /* MONOSPACE FONTS FOR DATA */
        .mono-text { font-family: 'JetBrains Mono', monospace; }

        /* INPUTS */
        .void-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
            transition: 0.3s;
            outline: none;
        }
        .void-input:focus {
            border-color: var(--accent);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .void-input:disabled { opacity: 0.5; cursor: not-allowed; background: transparent; border-color: transparent; padding-left: 0; }
        
        /* Specific style for Date Input to make it look like text when disabled */
        .date-input:disabled { text-align: center; color: rgba(255,255,255,0.5); }
        .date-input:enabled { text-align: center; color: var(--accent); border-color: var(--accent); }

        /* STATUS BADGES */
        .status-badge {
            display: inline-flex; justify-content: center; align-items: center;
            padding: 6px 16px; border-radius: 99px;
            font-size: 11px; font-weight: 800; letter-spacing: 1px;
            transition: 0.3s; cursor: pointer;
            border: 1px solid transparent;
            width: 110px;
        }
        .status-badge.used {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.1);
        }
        .status-badge.used:hover { background: rgba(34, 197, 94, 0.2); box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        
        .status-badge.free {
            background: rgba(255, 255, 255, 0.05);
            color: #9ca3af;
            border-color: rgba(255, 255, 255, 0.1);
        }
        .status-badge.free:hover { background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 15px rgba(255, 255, 255, 0.05); }
        .status-badge:disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* ACTION BUTTONS */
        .action-btn {
            width: 34px; height: 34px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.03); border: 1px solid transparent;
            color: var(--text-dim); transition: 0.2s;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; transform: scale(1.05); }
        .action-btn.has-video { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }
        .action-btn.is-critical { color: var(--critical); border-color: var(--critical); background: rgba(239, 68, 68, 0.1); }

        /* SEARCH & FILTERS */
        .search-container {
            position: relative;
            background: rgba(255,255,255,0.05);
            border-radius: 99px;
            padding: 2px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            width: 300px;
        }
        .search-icon { padding: 0 15px; color: var(--text-dim); }
        .search-input { background: transparent; border: none; outline: none; color: white; padding: 10px 0; width: 100%; font-size: 14px; }

        /* Filter Pills */
        .filter-pill {
            padding: 6px 18px; border-radius: 99px; font-size: 10px; font-weight: 800; 
            color: var(--text-dim); border: 1px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .filter-pill:hover { background: rgba(255,255,255,0.05); color: white; }
        .filter-pill.active {
            background: var(--accent); color: black; box-shadow: 0 0 15px var(--accent-glow); transform: scale(1.05);
        }

        /* STATS CARDS */
        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--glass-border); padding: 15px 25px; border-radius: 16px; display: flex; flex-direction: column; align-items: center;
        }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 4px; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: white; }

        /* MODALS */
        .glass-modal { background: #0a0a0c; border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8); }
        .error-banner { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 13px; display: none; backdrop-filter: blur(10px); }

        /* TOAST */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--accent); color: black; padding: 12px 24px; border-radius: 99px;
            font-weight: 800; font-size: 12px; box-shadow: 0 10px 30px var(--accent-glow);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; pointer-events: none;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <!-- TOP NAV -->
    <div class="top-bar">
        <div class="flex items-center gap-4">
            <!-- LOGO RESTORED -->
            <div class="w-10 h-10 rounded-full bg-[var(--accent)] bg-opacity-10 border border-[var(--accent)] border-opacity-20 flex items-center justify-center text-[var(--accent)] transition-colors shadow-[0_0_15px_var(--accent-glow)]">
                <i class="fa-solid fa-shield-halved text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-black tracking-tighter text-white">SRR <span style="color:var(--accent)" class="transition-colors">FILES</span></h1>
                <div class="flex items-center gap-2 text-[10px] font-bold tracking-widest text-white/40 uppercase">
                    <div id="connection-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="connection-text">Connecting...</span>
                </div>
            </div>
        </div>

        <div class="hidden md:flex gap-4">
            <div class="stat-card">
                <span class="stat-label">Total</span>
                <span class="stat-val">50</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Used</span>
                <span class="stat-val text-green-400" id="stat-used">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Free</span>
                <span class="stat-val text-blue-400" id="stat-remaining">--</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="hidden md:flex gap-2 mr-4">
                <button onclick="exportCSV()" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-[10px] font-bold border border-white/10 transition">REPORT</button>
                <button onclick="toggleTheme()" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-[10px] font-bold border border-white/10 transition">THEME</button>
            </div>
            <div id="auth-ui">
                <button onclick="document.getElementById('login-modal').classList.remove('hidden')" 
                    class="px-5 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-bold tracking-wide transition">
                    <i class="fa-solid fa-lock mr-2"></i> LOGIN
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="max-w-7xl mx-auto p-6 md:p-10 relative z-10">

        <!-- ERROR MESSAGE -->
        <div id="firestore-error" class="error-banner">
            <strong class="block mb-2 text-white text-base"><i class="fa-solid fa-triangle-exclamation mr-2"></i> SETUP REQUIRED</strong>
            Please create the Firestore Database in Firebase Console (Start in Test Mode).
        </div>

        <!-- CONTROLS & FILTERS -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="search-container">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search Database ID...">
            </div>

            <!-- Fixed Filter Pills -->
            <div class="flex bg-white/5 p-1 rounded-full border border-white/10 gap-1">
                <button onclick="window.setFilter('all')" class="filter-pill active" data-filter="all">ALL FILES</button>
                <button onclick="window.setFilter('used')" class="filter-pill" data-filter="used">USED</button>
                <button onclick="window.setFilter('critical')" class="filter-pill" data-filter="critical">CRITICAL</button>
                <button onclick="window.setFilter('video')" class="filter-pill" data-filter="video">EVIDENCE</button>
            </div>
        </div>

        <!-- THE LIST -->
        <div class="glass-panel p-2 md:p-6 min-h-[600px]">
            <div class="case-row header hidden md:grid">
                <span>Identifier</span>
                <div class="text-center">Status</div>
                <div class="text-center">Tools</div>
                <div class="text-center">Timestamp</div>
                <span>Agent / Notes</span>
            </div>

            <div id="tableBody" class="space-y-1">
                <div class="text-center py-20 text-white/20 font-bold tracking-widest animate-pulse">Initializing Secure Link...</div>
            </div>
        </div>

        <div class="text-center mt-12 mb-4 text-[10px] text-white/20 font-mono tracking-widest uppercase">
            System Developed by <span class="text-white/40">rick_grimesz</span> & <span class="text-white/40">Gemini</span> // SRR FILES V3.2
        </div>
    </div>

    <!-- TOAST POPUP -->
    <div id="toast"><i class="fa-solid fa-circle-check mr-2"></i>SAVED SUCCESSFULLY</div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-modal w-full max-w-md p-8 relative">
            <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="absolute top-4 right-4 text-white/30 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-full bg-[var(--accent)] bg-opacity-20 text-[var(--accent)] flex items-center justify-center mx-auto mb-4 text-2xl border border-[var(--accent)] border-opacity-30">
                    <i class="fa-solid fa-fingerprint"></i>
                </div>
                <h2 class="text-xl font-bold text-white">Admin Authorization</h2>
            </div>
            <input type="email" id="email-input" placeholder="Agent ID" class="void-input mb-3 bg-black/40 border-white/10 py-3">
            <input type="password" id="pass-input" placeholder="Passcode" class="void-input mb-6 bg-black/40 border-white/10 py-3">
            <button id="confirm-login" class="w-full py-3 bg-[var(--accent)] hover:opacity-90 text-black font-bold rounded-lg transition shadow-lg shadow-blue-500/20">AUTHENTICATE</button>
        </div>
    </div>

    <!-- VIDEO MODAL -->
    <div id="video-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="glass-modal w-full max-w-3xl p-6 relative border border-white/10">
            <button onclick="closeVideoModal()" class="absolute top-4 right-4 text-white/30 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <div class="flex items-center gap-3 mb-4">
                <div class="text-[var(--accent)]"><i class="fa-solid fa-film text-lg"></i></div>
                <div>
                    <h3 class="text-lg font-bold text-white leading-none">Evidence Locker</h3>
                    <p class="text-[10px] text-white/40 font-mono mt-1" id="vid-modal-id">CASE ID: ---</p>
                </div>
            </div>

            <div id="video-player-container" class="aspect-video bg-black rounded-xl border border-white/10 flex items-center justify-center mb-6 overflow-hidden relative shadow-2xl">
                <div class="text-white/30 text-sm flex flex-col items-center gap-2">
                    <i class="fa-solid fa-eye-slash text-2xl"></i>
                    <span>No Digital Evidence Found</span>
                </div>
            </div>

            <div id="video-input-area" class="hidden bg-white/5 p-4 rounded-xl border border-white/5">
                <label class="text-[10px] uppercase font-bold text-white/40 block mb-2">Update Evidence Link (YouTube / MP4 / Drive)</label>
                <div class="flex gap-2">
                    <input type="text" id="video-url-input" class="void-input flex-grow bg-black/50" placeholder="https://...">
                    <button onclick="saveVideo()" class="px-6 py-2 bg-[var(--accent)] text-black font-bold rounded-lg text-xs hover:scale-105 transition">SAVE EVIDENCE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDCuNTrF67ir5FivcC-eLxU54hmEHgTWZg",
            authDomain: "srr-files.firebaseapp.com",
            databaseURL: "https://srr-files-default-rtdb.firebaseio.com",
            projectId: "srr-files",
            storageBucket: "srr-files.firebasestorage.app",
            messagingSenderId: "631780470080",
            appId: "1:631780470080:web:54e2c12fef407274c51ea5",
            measurementId: "G-047TMV0Y3X"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let app, db, auth;
        let isAdmin = false;
        let casesData = {};
        let currentModalId = null;

        const defaultIds = [
            "SRR-8291-ALPHA", "SRR-1029-BRAVO", "SRR-5542-CHARLIE", "SRR-9921-DELTA", "SRR-3312-ECHO",
            "SRR-7748-FOXTROT", "SRR-2110-GOLF", "SRR-6659-HOTEL", "SRR-0092-INDIA", "SRR-4438-JULIETT",
            "SRR-1288-KILO", "SRR-9928-LIMA", "SRR-3374-MIKE", "SRR-7112-NOVEMBER", "SRR-2291-OSCAR",
            "SRR-6638-PAPA", "SRR-5510-QUEBEC", "SRR-1192-ROMEO", "SRR-8837-SIERRA", "SRR-4429-TANGO",
            "SRR-3381-UNIFORM", "SRR-7729-VICTOR", "SRR-2210-WHISKEY", "SRR-9948-XRAY", "SRR-5537-YANKEE",
            "SRR-1120-ZULU", "SRR-6691-MAX", "SRR-8822-NEXUS", "SRR-3319-VOID", "SRR-7741-PRIME",
            "SRR-2258-FLUX", "SRR-9910-CORE", "SRR-5582-LINK", "SRR-1139-NODE", "SRR-6621-GATE",
            "SRR-8849-KEY", "SRR-0012-LOCK", "SRR-4458-SAFE", "SRR-3392-VAULT", "SRR-7718-CRYPT",
            "SRR-2269-CHAIN", "SRR-6681-BLOCK", "SRR-5522-HASH", "SRR-1149-SALT", "SRR-8891-PEPER",
            "SRR-0038-IRON", "SRR-4472-STEEL", "SRR-3361-GOLD", "SRR-7759-SILVER", "SRR-2281-PLATINUM"
        ];

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            startApp();
        } catch (e) { console.error("Init Error", e); }

        function startApp() {
            onAuthStateChanged(auth, (user) => {
                const ui = document.getElementById('auth-ui');
                if (user) {
                    isAdmin = true;
                    ui.innerHTML = `<button id="logout-btn" class="px-4 py-2 bg-red-500/10 text-red-400 border border-red-500/20 rounded-full text-xs font-bold">LOGOUT</button>`;
                    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                    checkAndInitDB();
                } else {
                    isAdmin = false;
                    ui.innerHTML = `<button onclick="document.getElementById('login-modal').classList.remove('hidden')" class="px-5 py-2 rounded-full bg-white/5 border border-white/10 text-xs font-bold hover:bg-white/10">LOGIN</button>`;
                }
                renderTable();
            });

            onSnapshot(collection(db, "cases"), (snapshot) => {
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                document.getElementById('connection-text').innerText = "SECURE LINK ESTABLISHED";
                document.getElementById('firestore-error').style.display = 'none';
                
                snapshot.forEach((doc) => {
                    casesData[doc.id] = doc.data();
                });
                renderTable();
            }, (error) => {
                console.error("DB Error:", error);
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-red-600";
                document.getElementById('connection-text').innerText = "CONNECTION FAILED";
                if(error.code === 'permission-denied' || error.code === 'not-found') document.getElementById('firestore-error').style.display = 'block';
            });
        }

        async function checkAndInitDB() {
            try {
                const snap = await getDoc(doc(db, "cases", defaultIds[0]));
                if (!snap.exists()) {
                    defaultIds.forEach(async (id) => await setDoc(doc(db, "cases", id), { used: false, date: "", name: "", video: "", priority: false }));
                }
            } catch(e) {}
        }

        // RENDER LOGIC
        let currentFilter = 'all';
        window.setFilter = (type) => {
            currentFilter = type;
            document.querySelectorAll('.filter-pill').forEach(btn => {
                if(btn.dataset.filter === type) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderTable();
        };

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchInput = document.getElementById('searchInput');
            const filterText = searchInput ? searchInput.value.toUpperCase() : '';
            
            const loader = tbody.querySelector('.animate-pulse');
            if(loader && Object.keys(casesData).length > 0) loader.remove();

            let usedCount = 0;
            const sortedIds = Object.keys(casesData).sort((a,b) => {
                const pA = casesData[a].priority ? 1 : 0;
                const pB = casesData[b].priority ? 1 : 0;
                if(pA !== pB) return pB - pA;
                return defaultIds.indexOf(a) - defaultIds.indexOf(b);
            });

            if (sortedIds.length === 0) return;

            sortedIds.forEach(id => {
                const data = casesData[id];
                if (data.used) usedCount++;

                let isVisible = true;
                if (filterText && !id.includes(filterText) && !data.name.toUpperCase().includes(filterText)) isVisible = false;
                if (currentFilter === 'used' && !data.used) isVisible = false;
                if (currentFilter === 'free' && data.used) isVisible = false;
                if (currentFilter === 'critical' && !data.priority) isVisible = false;
                if (currentFilter === 'video' && !data.video) isVisible = false;

                let row = document.getElementById(`row-${id}`);
                
                if (!row) {
                    row = document.createElement('div');
                    row.id = `row-${id}`;
                    row.innerHTML = `
                        <div class="mono-text text-sm font-bold text-white/90 flex items-center gap-2">
                            ${id} <i class="fa-solid fa-triangle-exclamation text-red-500 hidden priority-icon" title="Critical Case"></i>
                        </div>
                        <div class="text-center">
                            <button class="status-badge" data-action="toggle">AVAILABLE</button>
                        </div>
                        <div class="flex justify-center gap-2">
                            <button class="action-btn" data-action="video" title="Evidence Locker"><i class="fa-solid fa-film"></i></button>
                            <button class="action-btn" data-action="priority" title="Mark Critical"><i class="fa-solid fa-star"></i></button>
                        </div>
                        <div>
                            <!-- EDITABLE DATE INPUT -->
                            <input type="text" class="void-input font-mono text-center text-xs date-input" placeholder="--" data-action="date">
                        </div>
                        <div>
                            <input type="text" class="void-input font-mono" placeholder="..." data-action="name">
                        </div>
                    `;
                    tbody.appendChild(row);

                    // BIND EVENTS
                    row.querySelector('[data-action="toggle"]').onclick = () => toggleStatus(id);
                    row.querySelector('[data-action="name"]').oninput = (e) => updateName(id, e.target.value);
                    row.querySelector('[data-action="date"]').onchange = (e) => updateDate(id, e.target.value); // Add Date Listener
                    row.querySelector('[data-action="video"]').onclick = () => openVideoModal(id);
                    row.querySelector('[data-action="priority"]').onclick = () => togglePriority(id);
                }

                row.style.display = isVisible ? 'grid' : 'none';

                if (isVisible) {
                    row.className = `case-row ${data.priority ? 'critical' : ''}`;
                    row.querySelector('.priority-icon').style.display = data.priority ? 'inline' : 'none';

                    // Status
                    const btn = row.querySelector('[data-action="toggle"]');
                    const statusClass = data.used ? 'used' : 'free';
                    const statusLabel = data.used ? 'USED' : 'AVAILABLE';
                    if (btn.className !== `status-badge ${statusClass}`) btn.className = `status-badge ${statusClass}`;
                    if (btn.innerText !== statusLabel) btn.innerText = statusLabel;

                    // Date (Protected Input)
                    const dateInput = row.querySelector('[data-action="date"]');
                    if (document.activeElement !== dateInput) {
                        if (dateInput.value !== (data.date || '')) dateInput.value = data.date || '';
                    }

                    // Buttons
                    const vidBtn = row.querySelector('[data-action="video"]');
                    const priBtn = row.querySelector('[data-action="priority"]');
                    
                    if(data.video && !vidBtn.classList.contains('has-video')) vidBtn.classList.add('has-video');
                    else if(!data.video && vidBtn.classList.contains('has-video')) vidBtn.classList.remove('has-video');

                    if(data.priority && !priBtn.classList.contains('is-critical')) priBtn.classList.add('is-critical');
                    else if(!data.priority && priBtn.classList.contains('is-critical')) priBtn.classList.remove('is-critical');

                    // Name (Protected Input)
                    const input = row.querySelector('[data-action="name"]');
                    if (document.activeElement !== input && input.value !== data.name) input.value = data.name;

                    // Permissions
                    const btns = row.querySelectorAll('button:not([data-action="video"]), input');
                    btns.forEach(b => b.disabled = !isAdmin);
                    priBtn.style.opacity = isAdmin ? 1 : 0.2;
                    priBtn.style.pointerEvents = isAdmin ? 'auto' : 'none';
                }
            });

            // Update Stats
            if(document.getElementById('stat-used')) document.getElementById('stat-used').innerText = usedCount;
            if(document.getElementById('stat-remaining')) document.getElementById('stat-remaining').innerText = 50 - usedCount;

            if (searchInput) searchInput.oninput = renderTable;
        }

        async function toggleStatus(id) {
            if(!isAdmin) return;
            const current = casesData[id];
            const newStatus = !current.used;
            let updateData = { used: newStatus };
            // Auto-generate date if turning ON, but only if date is empty
            if (newStatus && !current.date) {
                const now = new Date();
                updateData.date = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '');
            } else if (!newStatus) { 
                updateData.date = ""; // Clear date if resetting
            }
            await updateDoc(doc(db, "cases", id), updateData);
        }

        async function updateName(id, val) {
            if(!isAdmin) return;
            await updateDoc(doc(db, "cases", id), { name: val });
        }
        
        // NEW: Update Date Manually
        async function updateDate(id, val) {
            if(!isAdmin) return;
            await updateDoc(doc(db, "cases", id), { date: val });
        }

        async function togglePriority(id) {
            if(!isAdmin) return;
            const current = casesData[id].priority || false;
            await updateDoc(doc(db, "cases", id), { priority: !current });
        }

        // VIDEO
        window.openVideoModal = (id) => {
            currentModalId = id;
            document.getElementById('video-modal').classList.remove('hidden');
            document.getElementById('vid-modal-id').innerText = `CASE ID: ${id}`;
            document.getElementById('video-input-area').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('video-url-input').value = casesData[id].video || "";
            
            const container = document.getElementById('video-player-container');
            const url = casesData[id].video;
            
            if(url) {
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    let vidId = url.split('v=')[1];
                    const ampersandPosition = vidId ? vidId.indexOf('&') : -1;
                    if(ampersandPosition !== -1) vidId = vidId.substring(0, ampersandPosition);
                    container.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe>`;
                } else if(url.endsWith('.mp4')) {
                    container.innerHTML = `<video src="${url}" controls class="w-full h-full"></video>`;
                } else {
                    container.innerHTML = `<a href="${url}" target="_blank" class="text-[var(--accent)] underline flex flex-col items-center gap-2"><i class="fa-solid fa-external-link-alt text-2xl"></i> Open External Evidence</a>`;
                }
            } else {
                container.innerHTML = `<div class="text-white/30 text-sm flex flex-col items-center gap-2"><i class="fa-solid fa-eye-slash text-2xl"></i><span>No Digital Evidence Found</span></div>`;
            }
        };

        window.closeVideoModal = () => {
            document.getElementById('video-modal').classList.add('hidden');
            document.getElementById('video-player-container').innerHTML = ''; 
        };

        window.saveVideo = async () => {
            if(!isAdmin || !currentModalId) return;
            const url = document.getElementById('video-url-input').value;
            await updateDoc(doc(db, "cases", currentModalId), { video: url });
            
            // SHOW TOAST
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
            
            closeVideoModal();
        };

        window.exportCSV = () => {
            let csv = "ID,Status,Date,Agent,Priority,EvidenceLink\n";
            Object.keys(casesData).forEach(id => {
                const r = casesData[id];
                csv += `${id},${r.used?'USED':'FREE'},${r.date},${r.name},${r.priority?'CRITICAL':'NORMAL'},${r.video||''}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SRR_Report_${Date.now()}.csv`;
            a.click();
        };

        window.toggleTheme = () => document.body.classList.toggle('theme-red');

        // Login UI
        document.getElementById('confirm-login').onclick = async () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('pass-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                document.getElementById('login-modal').classList.add('hidden');
            } catch (e) { alert("Access Denied"); }
        };
    </script>
</body>
</html>
