<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRR DATABASE v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        
        :root {
            --glass-base: rgba(20, 20, 25, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            --text-main: rgba(255, 255, 255, 0.95);
            --text-dim: rgba(255, 255, 255, 0.5);
            --accent: #60a5fa; /* FBI Blue */
            --accent-glow: rgba(96, 165, 250, 0.3);
            --danger: #ef4444;
            --success: #22c55e;
            --bg-hue: 220;
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        /* CUSTOM SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ANIMATED BACKGROUND LAYER */
        #bg-layer { position: fixed; inset: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, hsl(var(--bg-hue), 60%, 8%) 0%, #000000 60%); opacity: 1; z-index: -3; animation: spin-slow 120s linear infinite; pointer-events: none; }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }

        /* GLASS PANELS */
        .glass-panel { 
            background: var(--glass-base); 
            backdrop-filter: blur(20px) saturate(110%); 
            -webkit-backdrop-filter: blur(20px) saturate(110%); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            border-radius: var(--radius-lg); 
        }

        /* TOP BAR */
        .top-bar { 
            position: sticky; top: 0; z-index: 50; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px 30px; 
            background: rgba(0,0,0,0.3); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        /* DATA TABLE STYLING */
        .case-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1.5fr 2fr;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            background: rgba(255,255,255,0.02);
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .case-row:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        .case-row.header {
            background: transparent;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
            color: var(--text-dim);
            padding: 10px 20px;
            pointer-events: none;
        }

        /* MONOSPACE FONTS FOR DATA */
        .mono-text { font-family: 'JetBrains Mono', monospace; }

        /* INPUTS */
        .void-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
            transition: 0.3s;
            outline: none;
        }
        .void-input:focus {
            border-color: var(--accent);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .void-input:disabled { opacity: 0.5; cursor: not-allowed; }

        /* STATUS BADGES */
        .status-badge {
            display: inline-flex; justify-content: center; align-items: center;
            padding: 6px 16px; border-radius: 99px;
            font-size: 11px; font-weight: 800; letter-spacing: 1px;
            transition: 0.3s; cursor: pointer;
            border: 1px solid transparent;
            width: 100px;
        }
        .status-badge.used {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.1);
        }
        .status-badge.used:hover { background: rgba(34, 197, 94, 0.2); box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        
        .status-badge.free {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.2);
        }
        .status-badge.free:hover { background: rgba(239, 68, 68, 0.2); box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }

        .status-badge:disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* SEARCH BAR */
        .search-container {
            position: relative;
            background: rgba(255,255,255,0.05);
            border-radius: 99px;
            padding: 2px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            width: 300px;
        }
        .search-icon { padding: 0 15px; color: var(--text-dim); }
        .search-input {
            background: transparent; border: none; outline: none;
            color: white; padding: 10px 0; width: 100%; font-size: 14px;
        }

        /* STATS CARDS */
        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--glass-border);
            padding: 15px 25px;
            border-radius: 16px;
            display: flex; flex-direction: column; align-items: center;
        }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 4px; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: white; }

        /* MODAL */
        .glass-modal {
            background: rgba(10, 10, 12, 0.9);
            backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8);
        }
        
        /* ERROR BANNER */
        .error-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
            backdrop-filter: blur(10px);
            white-space: pre-line;
            line-height: 1.6;
        }
    </style>
</head>
<body>

    <!-- ANIMATED BACKGROUND -->
    <div id="bg-layer"></div>

    <!-- TOP NAV -->
    <div class="top-bar">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-blue-500/10 border border-blue-500/20 flex items-center justify-center text-blue-400">
                <i class="fa-solid fa-shield-halved text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-black tracking-tighter text-white">SRR <span class="text-blue-400">CLOUD</span></h1>
                <div class="flex items-center gap-2 text-[10px] font-bold tracking-widest text-white/40 uppercase">
                    <div id="connection-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="connection-text">Connecting...</span>
                </div>
            </div>
        </div>

        <div class="hidden md:flex gap-4">
            <div class="stat-card">
                <span class="stat-label">Total</span>
                <span class="stat-val">50</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Used</span>
                <span class="stat-val text-green-400" id="stat-used">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Free</span>
                <span class="stat-val text-blue-400" id="stat-remaining">--</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div id="auth-ui">
                <button onclick="document.getElementById('login-modal').classList.remove('hidden')" 
                    class="px-5 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-bold tracking-wide transition">
                    <i class="fa-solid fa-lock mr-2"></i> LOGIN
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="max-w-7xl mx-auto p-6 md:p-10 relative z-10">

        <!-- ERROR MESSAGE CONTAINER -->
        <div id="firestore-error" class="error-banner">
            <strong class="block mb-2 text-white text-base"><i class="fa-solid fa-triangle-exclamation mr-2"></i> SETUP REQUIRED: Database Not Found</strong>
            The system cannot connect because the database does not exist yet.
            
            <span class="text-white block mt-2 font-bold">HOW TO FIX:</span>
            1. Go to your <a href="https://console.firebase.google.com/" target="_blank" class="underline hover:text-white">Firebase Console</a>.
            2. Click on your project <strong>srr-files</strong>.
            3. In the left menu, click <strong>Build</strong> -> <strong>Firestore Database</strong>.
            4. Click the <strong>Create Database</strong> button.
            5. Select a location (any is fine).
            6. <strong>IMPORTANT:</strong> Select <strong>"Start in Test Mode"</strong> (This fixes the permission errors).
            7. Click Create, wait for it to finish, then refresh this page.
        </div>

        <!-- CONTROLS ROW -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="search-container">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search Database ID...">
            </div>

            <div class="flex bg-white/5 p-1 rounded-full border border-white/10">
                <button onclick="window.setFilter('all')" class="filter-btn active px-6 py-2 rounded-full text-xs font-bold text-white bg-white/10 transition" data-filter="all">ALL</button>
                <button onclick="window.setFilter('used')" class="filter-btn px-6 py-2 rounded-full text-xs font-bold text-white/40 hover:text-white transition" data-filter="used">USED</button>
                <button onclick="window.setFilter('free')" class="filter-btn px-6 py-2 rounded-full text-xs font-bold text-white/40 hover:text-white transition" data-filter="free">FREE</button>
            </div>
        </div>

        <!-- THE LIST -->
        <div class="glass-panel p-2 md:p-6 min-h-[600px]">
            <!-- Table Header -->
            <div class="case-row header hidden md:grid">
                <span>Case Identifier</span>
                <div class="text-center">Status</div>
                <span>Timestamp</span>
                <span>Agent / Notes</span>
            </div>

            <!-- List Container -->
            <div id="tableBody" class="space-y-1">
                <!-- Javascript injects rows here -->
                <div class="text-center py-20 text-white/20 font-bold tracking-widest animate-pulse">Initializing Secure Link...</div>
            </div>
        </div>

        <div class="text-center mt-8 text-xs text-white/20 font-mono">
            SECURE RECORD RECORDING SYSTEM // V2.0 // ENCRYPTED
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-modal w-full max-w-md p-8 relative">
            <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="absolute top-4 right-4 text-white/30 hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center mx-auto mb-4 text-2xl border border-blue-500/30">
                    <i class="fa-solid fa-fingerprint"></i>
                </div>
                <h2 class="text-xl font-bold text-white">Admin Authorization</h2>
                <p class="text-sm text-white/40 mt-1">Enter credentials to modify database.</p>
            </div>

            <input type="email" id="email-input" placeholder="Agent ID (Email)" class="void-input mb-3 bg-black/40 border-white/10 py-3">
            <input type="password" id="pass-input" placeholder="Passcode" class="void-input mb-6 bg-black/40 border-white/10 py-3">

            <button id="confirm-login" class="w-full py-3 bg-blue-500 hover:bg-blue-400 text-black font-bold rounded-lg transition shadow-lg shadow-blue-500/20">
                AUTHENTICATE
            </button>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        // -----------------------------------------------------------
        // CONFIGURATION
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDCuNTrF67ir5FivcC-eLxU54hmEHgTWZg",
            authDomain: "srr-files.firebaseapp.com",
            databaseURL: "https://srr-files-default-rtdb.firebaseio.com",
            projectId: "srr-files",
            storageBucket: "srr-files.firebasestorage.app",
            messagingSenderId: "631780470080",
            appId: "1:631780470080:web:54e2c12fef407274c51ea5",
            measurementId: "G-047TMV0Y3X"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // APP STATE
        let app, db, auth;
        let isAdmin = false;
        let casesData = {};
        const defaultIds = [
            "SRR-8291-ALPHA", "SRR-1029-BRAVO", "SRR-5542-CHARLIE", "SRR-9921-DELTA", "SRR-3312-ECHO",
            "SRR-7748-FOXTROT", "SRR-2110-GOLF", "SRR-6659-HOTEL", "SRR-0092-INDIA", "SRR-4438-JULIETT",
            "SRR-1288-KILO", "SRR-9928-LIMA", "SRR-3374-MIKE", "SRR-7112-NOVEMBER", "SRR-2291-OSCAR",
            "SRR-6638-PAPA", "SRR-5510-QUEBEC", "SRR-1192-ROMEO", "SRR-8837-SIERRA", "SRR-4429-TANGO",
            "SRR-3381-UNIFORM", "SRR-7729-VICTOR", "SRR-2210-WHISKEY", "SRR-9948-XRAY", "SRR-5537-YANKEE",
            "SRR-1120-ZULU", "SRR-6691-MAX", "SRR-8822-NEXUS", "SRR-3319-VOID", "SRR-7741-PRIME",
            "SRR-2258-FLUX", "SRR-9910-CORE", "SRR-5582-LINK", "SRR-1139-NODE", "SRR-6621-GATE",
            "SRR-8849-KEY", "SRR-0012-LOCK", "SRR-4458-SAFE", "SRR-3392-VAULT", "SRR-7718-CRYPT",
            "SRR-2269-CHAIN", "SRR-6681-BLOCK", "SRR-5522-HASH", "SRR-1149-SALT", "SRR-8891-PEPER",
            "SRR-0038-IRON", "SRR-4472-STEEL", "SRR-3361-GOLD", "SRR-7759-SILVER", "SRR-2281-PLATINUM"
        ];

        // INIT
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            startApp();
        } catch (e) {
            console.error("Init Error", e);
        }

        function startApp() {
            // AUTH LISTENER
            onAuthStateChanged(auth, (user) => {
                const ui = document.getElementById('auth-ui');
                if (user) {
                    isAdmin = true;
                    ui.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-green-400 uppercase tracking-widest bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20">
                                <i class="fa-solid fa-circle-check mr-1"></i> Admin Active
                            </span>
                            <button id="logout-btn" class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                        </div>
                    `;
                    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                    checkAndInitDB();
                } else {
                    isAdmin = false;
                    ui.innerHTML = `
                        <button onclick="document.getElementById('login-modal').classList.remove('hidden')" 
                            class="px-5 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-bold tracking-wide transition">
                            <i class="fa-solid fa-lock mr-2"></i> LOGIN
                        </button>
                    `;
                }
                renderTable();
            });

            // DB LISTENER
            onSnapshot(collection(db, "cases"), (snapshot) => {
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                document.getElementById('connection-text').innerText = "SECURE LINK ESTABLISHED";
                document.getElementById('firestore-error').style.display = 'none'; // Hide error if success
                
                snapshot.forEach((doc) => {
                    casesData[doc.id] = doc.data();
                });
                renderTable();
            }, (error) => {
                console.error("DB Error:", error);
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-red-600";
                document.getElementById('connection-text').innerText = "CONNECTION FAILED";
                
                // SHOW ERROR BANNER for specific codes
                if(error.code === 'permission-denied' || error.code === 'not-found' || error.message.includes('Cloud Firestore API')) {
                    document.getElementById('firestore-error').style.display = 'block';
                }
            });
        }

        async function checkAndInitDB() {
            try {
                const docRef = doc(db, "cases", defaultIds[0]);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    defaultIds.forEach(async (id) => {
                        await setDoc(doc(db, "cases", id), { used: false, date: "", name: "" });
                    });
                }
            } catch(e) { console.log("Seeding check skipped/failed"); }
        }

        // RENDER
        let currentFilter = 'all';
        window.setFilter = (type) => {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === type) {
                    btn.classList.add('bg-white/10', 'text-white');
                    btn.classList.remove('text-white/40');
                } else {
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('text-white/40');
                }
            });
            renderTable();
        };

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchInput = document.getElementById('searchInput');
            const filterText = searchInput ? searchInput.value.toUpperCase() : '';
            
            // REMOVED: tbody.innerHTML = '' (This caused the focus loss)
            // Added loading spinner removal
            const loader = tbody.querySelector('.animate-pulse');
            if(loader && Object.keys(casesData).length > 0) loader.remove();

            let usedCount = 0;
            const sortedIds = Object.keys(casesData).sort((a,b) => defaultIds.indexOf(a) - defaultIds.indexOf(b));

            if (sortedIds.length === 0) return;

            sortedIds.forEach(id => {
                const data = casesData[id];
                if (data.used) usedCount++;

                let isVisible = true;
                if (filterText && !id.includes(filterText) && !data.name.toUpperCase().includes(filterText)) isVisible = false;
                if (currentFilter === 'used' && !data.used) isVisible = false;
                if (currentFilter === 'free' && data.used) isVisible = false;

                // SMART RENDER: Find existing row or create new one
                let row = document.getElementById(`row-${id}`);
                
                if (!row) {
                    row = document.createElement('div');
                    row.id = `row-${id}`;
                    row.className = 'case-row';
                    // Create Structure
                    row.innerHTML = `
                        <div class="mono-text text-sm font-bold text-white/90">${id}</div>
                        <div class="text-center">
                            <button class="status-badge" data-action="toggle">AVAILABLE</button>
                        </div>
                        <div class="mono-text text-xs text-white/50 date-field"></div>
                        <div>
                            <input type="text" class="void-input font-mono" placeholder="..." data-action="name">
                        </div>
                    `;
                    tbody.appendChild(row);

                    // Bind Events Once
                    const btn = row.querySelector('button');
                    const input = row.querySelector('input');
                    btn.onclick = () => toggleStatus(id);
                    input.oninput = (e) => updateName(id, e.target.value);
                }

                // Apply Visibility
                row.style.display = isVisible ? 'grid' : 'none';

                if (isVisible) {
                    const btn = row.querySelector('button');
                    const dateField = row.querySelector('.date-field');
                    const input = row.querySelector('input');

                    // Status Update
                    const statusClass = data.used ? 'used' : 'free';
                    const statusLabel = data.used ? 'USED' : 'AVAILABLE';
                    if (btn.className !== `status-badge ${statusClass}`) btn.className = `status-badge ${statusClass}`;
                    if (btn.innerText !== statusLabel) btn.innerText = statusLabel;

                    // Date Update
                    const dateVal = data.used ? data.date : '--';
                    if (dateField.innerText !== dateVal) dateField.innerText = dateVal;

                    // Input Update (Protected)
                    // Only update the text if the user IS NOT currently typing in this specific box
                    if (document.activeElement !== input) {
                        if (input.value !== data.name) input.value = data.name;
                    }

                    // Permissions
                    const disabled = !isAdmin;
                    if (btn.disabled !== disabled) btn.disabled = disabled;
                    if (input.disabled !== disabled) input.disabled = disabled;
                }
            });

            // STATS
            document.getElementById('stat-used').innerText = usedCount;
            document.getElementById('stat-remaining').innerText = 50 - usedCount;
            
            // Search listener
            if (searchInput) searchInput.oninput = renderTable;
        }

        async function toggleStatus(id) {
            if(!isAdmin) return;
            const current = casesData[id];
            const newStatus = !current.used;
            let updateData = { used: newStatus };
            if (newStatus) {
                const now = new Date();
                updateData.date = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '');
            } else { updateData.date = ""; }
            await updateDoc(doc(db, "cases", id), updateData);
        }

        async function updateName(id, val) {
            if(!isAdmin) return;
            await updateDoc(doc(db, "cases", id), { name: val });
        }

        // LOGIN HANDLER
        document.getElementById('confirm-login').onclick = async () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('pass-input').value;
            const btn = document.getElementById('confirm-login');
            
            try {
                btn.innerText = "AUTHENTICATING...";
                await signInWithEmailAndPassword(auth, email, pass);
                document.getElementById('login-modal').classList.add('hidden');
                btn.innerText = "AUTHENTICATE";
            } catch (error) {
                alert("ACCESS DENIED: " + error.message);
                btn.innerText = "TRY AGAIN";
            }
        };
    </script>
</body>
</html>
